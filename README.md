# SPA Sentirse Bien ‚Äì API ASP.NET Core

**Trabajo Pr√°ctico Integrador 2025 - Componente API RESTful**

## üéØ Descripci√≥n del Escenario

**Spa Sentirse Bien** es un sistema completo de gesti√≥n para un spa de relajaci√≥n y bienestar que permite:

- **Clientes**: Reservar turnos online, procesar pagos seguros, acceder a servicios exclusivos v√≠a QR
- **Profesionales**: Gestionar agenda diaria, consultar historial de clientes, registrar tratamientos
- **Administradores**: Control completo de usuarios, servicios, turnos, pagos y estad√≠sticas

Esta API RESTful sirve como backend unificado para el panel administrativo MVC y el frontend SPA (Next.js).

## üõ†Ô∏è Herramientas Utilizadas

### Framework y Lenguaje
- **ASP.NET Core 9.0** - Framework principal
- **C#** - Lenguaje de programaci√≥n
- **MongoDB Atlas** - Base de datos NoSQL en la nube

### Librer√≠as y Paquetes
- **Microsoft.AspNetCore.Authentication.JwtBearer 9.0.6** - Autenticaci√≥n JWT
- **BCrypt.Net-Next 4.0.3** - Hash seguro de contrase√±as
- **QRCoder 1.6.0** - Generaci√≥n de c√≥digos QR
- **DotNetEnv 3.1.1** - Gesti√≥n de variables de entorno
- **MongoDB.Driver 3.4.0** - Driver oficial de MongoDB
- **MailKit 4.13.0** - Env√≠o de emails
- **System.IdentityModel.Tokens.Jwt 8.12.1** - Manejo de tokens JWT
- **Swashbuckle.AspNetCore 9.0.1** - Documentaci√≥n OpenAPI/Swagger

### Seguridad
- **CORS** configurado para m√∫ltiples or√≠genes
- **JWT Bearer Authentication** con validaci√≥n completa
- **BCrypt password hashing** con salt autom√°tico

## üìã Cumplimiento de Requisitos TP-2025

### ‚úÖ Requisitos T√©cnicos Implementados

1. **‚úÖ API RESTful en ASP.NET Web API**
   - 7 controladores principales con endpoints REST completos
   - Documentaci√≥n autom√°tica con Swagger
   - Arquitectura limpia con separaci√≥n de responsabilidades

2. **‚úÖ Autenticaci√≥n JWT**
   - Tokens seguros con expiraci√≥n configurable
   - Claims personalizados con roles (cliente, profesional, admin)
   - Middleware de autenticaci√≥n en endpoints protegidos

3. **‚úÖ Registro de usuarios**
   - Endpoint `POST /api/auth/register` con validaciones DataAnnotations
   - Campos requeridos: email, contrase√±a, nombre, apellido, rol
   - Validaci√≥n de email √∫nico en base de datos

4. **‚úÖ Contrase√±as hasheadas con salt**
   - BCrypt.Net-Next con work factor autom√°tico
   - Salt autom√°tico generado por la librer√≠a
   - Compatibilidad con hashes de sistemas anteriores

5. **‚úÖ Recuperaci√≥n de contrase√±a**
   - Endpoint `POST /api/auth/forgot-password`
   - Tokens √∫nicos y seguros con expiraci√≥n de 1 hora
   - Endpoint `POST /api/auth/reset-password` para restablecer

6. **‚úÖ Listados paginados**
   - `PaginatedResponse<T>` est√°ndar en todos los endpoints de listado
   - Par√°metros: page, pageSize, filtros espec√≠ficos
   - Metadatos: totalCount, totalPages, hasNext, hasPrevious

7. **‚úÖ Vista de detalle**
   - Endpoints `GET /api/{resource}/{id}` para cada entidad
   - Informaci√≥n expandida con relaciones
   - Autorizaci√≥n por roles para acceso a detalles

8. **‚úÖ Crear elementos con dropdown/selector**
   - Endpoint `POST /api/services` con selector de tipos/categor√≠as
   - Validaci√≥n de roles en creaci√≥n de usuarios
   - M√©todos de pago predefinidos en sistema de pagos

9. **‚úÖ Editar elementos existentes**
   - Endpoints `PUT /api/{resource}/{id}` para todas las entidades
   - Validaciones de negocio implementadas
   - Autorizaci√≥n por roles y propietario

10. **‚úÖ C√≥digo QR generado desde backend**
    - `QRController` con generaci√≥n usando QRCoder library
    - Tokens criptogr√°ficamente seguros de 32 bytes
    - Almacenamiento en MongoDB con metadatos completos

11. **‚úÖ Funcionalidad exclusiva QR con enlaces temporales**
    - URLs con tokens que expiran (configurable 1-1440 minutos)
    - Validaci√≥n autom√°tica y marcado como "usado"
    - Funcionalidades exclusivas: check-in, ofertas especiales, acceso premium

## üöÄ Instalaci√≥n y Ejecuci√≥n

### Requisitos Previos
```bash
# Verificar versi√≥n de .NET
dotnet --version  # Debe ser 9.0 o superior
```

### 1. Clonar el repositorio
```bash
git clone https://github.com/tu-usuario/spa-sentirse-bien.git
cd spa-sentirse-bien/spa-sentirse-bien-api
```

### 2. Restaurar dependencias
```bash
dotnet restore
```

### 3. Configurar variables de entorno
Crear archivo `.env` en la ra√≠z del proyecto:

```env
# MongoDB Atlas
ConnectionStrings__MongoDB=mongodb+srv://usuario:password@cluster.mongodb.net/
MongoDatabase=sentirseBien

# JWT Configuration
JWT__Key=tu-clave-secreta-de-256-bits-minimo-para-jwt-seguro
JWT__Issuer=SentirseWellApi
JWT__Audience=SentirseWellClients
JWT__DurationInMinutes=120

# Email Configuration (Gmail)
Email__SenderEmail=tu-email@gmail.com
Email__GoogleClientId=tu-google-client-id
Email__GoogleClientSecret=tu-google-client-secret
Email__GoogleRefreshToken=tu-google-refresh-token

# QR Code Configuration
QRCode__BaseUrl=https://localhost:7000/api/qr

# CORS Configuration
CORS__AllowedOrigins=http://localhost:9002,https://localhost:9002,http://localhost:7001,https://localhost:7001
```

### 4. Ejecutar la aplicaci√≥n
```bash
dotnet run
```

### 5. Verificar funcionamiento
- **Swagger UI**: http://localhost:5018/swagger
- **Health Check**: http://localhost:5018/health
- **Base URL API**: http://localhost:5018/api

## üìö Controladores y Endpoints Implementados

### üîê AuthController (`/api/auth`)
- `POST /api/auth/register` - Registrar nuevo usuario
- `POST /api/auth/login` - Iniciar sesi√≥n
- `POST /api/auth/forgot-password` - Solicitar recuperaci√≥n de contrase√±a
- `POST /api/auth/reset-password` - Restablecer contrase√±a

### üë• UsersController (`/api/users`)
- `GET /api/users` - Listar usuarios (paginado)
- `GET /api/users/profesionales` - Listar profesionales
- `GET /api/users/clientes` - Listar clientes
- `GET /api/users/{id}` - Obtener usuario por ID
- `GET /api/users/profile` - Obtener perfil del usuario logueado
- `PUT /api/users/{id}` - Actualizar usuario
- `DELETE /api/users/{id}` - Eliminar usuario

### üè• ServicesController (`/api/services`)
- `GET /api/services` - Listar servicios (paginado)
- `GET /api/services/{id}` - Obtener servicio por ID
- `GET /api/services/name/{nombre}` - Buscar servicio por nombre
- `POST /api/services` - Crear servicio
- `PUT /api/services/{id}` - Actualizar servicio
- `DELETE /api/services/{id}` - Eliminar servicio
- `GET /api/services/tipos` - Obtener tipos de servicios

### üìÖ TurnosController (`/api/turnos`)
- `GET /api/turnos` - Listar turnos (paginado)
- `GET /api/turnos/{id}` - Obtener turno por ID
- `POST /api/turnos` - Crear turno
- `PUT /api/turnos/{id}` - Actualizar turno
- `DELETE /api/turnos/{id}` - Cancelar turno
- `GET /api/turnos/disponibilidad` - Consultar disponibilidad

### üí≥ PaymentsController (`/api/payments`)
- `GET /api/payments` - Listar pagos (paginado)
- `GET /api/payments/{id}` - Obtener pago por ID
- `POST /api/payments` - Crear registro de pago
- `POST /api/payments/process` - Procesar pago
- `POST /api/payments/{id}/refund` - Procesar reembolso
- `GET /api/payments/stats` - Estad√≠sticas de pagos

### üì± QRController (`/api/qr`)
- `POST /api/qr/generate` - Generar c√≥digo QR
- `GET /api/qr/validate/{token}` - Validar c√≥digo QR
- `GET /api/qr/info/{token}` - Informaci√≥n del QR
- `POST /api/qr/turno/{turnoId}/checkin` - Generar QR de check-in
- `GET /api/qr/history` - Historial de QRs (solo admin)

### üåê QrPagesController
- `GET /qr-success` - P√°gina de √©xito para QR
- `GET /qr-error` - P√°gina de error para QR

## üóÑÔ∏è Estructura de Base de Datos

### Colecciones MongoDB
- `users` - Usuarios del sistema (clientes, profesionales, admins)
- `services` - Servicios ofrecidos por el spa
- `turnos` - Reservas y citas programadas
- `payments` - Transacciones y pagos procesados
- `qrcodes` - C√≥digos QR generados con tokens temporales

### Modelos Principales
- **User** - Entidad de usuario con autenticaci√≥n y roles
- **Service** - Servicios del spa con categorizaci√≥n
- **Turno** - Sistema de reservas y citas
- **Payment** - Transacciones y m√©todos de pago
- **QRCode** - C√≥digos QR con expiraci√≥n y funcionalidades exclusivas
- **ApiResponse<T>** - Respuestas estandarizadas
- **PaginatedResponse<T>** - Respuestas paginadas

## üîê Seguridad Implementada

### Autenticaci√≥n JWT
- **Tokens seguros** con expiraci√≥n configurable (default: 120 minutos)
- **Claims personalizados** con roles y permisos
- **Validaci√≥n completa** de issuer, audience, lifetime y signing key

### Autorizaci√≥n
- **Roles granulares** (cliente, profesional, admin)
- **Policies espec√≠ficas** para diferentes operaciones
- **Validaci√≥n de ownership** en recursos privados

### Protecci√≥n de Contrase√±as
- **BCrypt.Net-Next** con salt autom√°tico
- **Migraci√≥n autom√°tica** de hashes legacy
- **Validaci√≥n de fortaleza** en registro

### C√≥digos QR Seguros
- **Tokens criptogr√°ficos** de 32 bytes
- **Expiraci√≥n temporal** configurable
- **Uso √∫nico** con marcado autom√°tico
- **Validaci√≥n de permisos** por tipo de acci√≥n

## üß™ Testing

```bash
# Ejecutar tests unitarios
dotnet test

# Tests con coverage
dotnet test --collect:"XPlat Code Coverage"

# Tests espec√≠ficos
dotnet test --filter "Category=Integration"
```

## üì¶ Estructura del Proyecto

```
spa-sentirse-bien-api/
‚îú‚îÄ‚îÄ Controllers/              # Controladores REST
‚îÇ   ‚îú‚îÄ‚îÄ AuthController.cs    # Autenticaci√≥n JWT
‚îÇ   ‚îú‚îÄ‚îÄ UsersController.cs   # Gesti√≥n de usuarios
‚îÇ   ‚îú‚îÄ‚îÄ ServicesController.cs # CRUD servicios
‚îÇ   ‚îú‚îÄ‚îÄ TurnosController.cs  # Sistema de turnos
‚îÇ   ‚îú‚îÄ‚îÄ PaymentsController.cs # Procesamiento pagos
‚îÇ   ‚îú‚îÄ‚îÄ QRController.cs      # C√≥digos QR din√°micos
‚îÇ   ‚îî‚îÄ‚îÄ QrPagesController.cs # P√°ginas de QR
‚îú‚îÄ‚îÄ Models/                  # Modelos de datos y DTOs
‚îÇ   ‚îú‚îÄ‚îÄ User.cs             # Usuario con DTOs
‚îÇ   ‚îú‚îÄ‚îÄ Service.cs          # Servicios del spa
‚îÇ   ‚îú‚îÄ‚îÄ Turno.cs            # Sistema de reservas
‚îÇ   ‚îú‚îÄ‚îÄ Payment.cs          # Transacciones
‚îÇ   ‚îú‚îÄ‚îÄ ApiResponse.cs      # Respuestas + QRCode
‚îÇ   ‚îî‚îÄ‚îÄ AppSettings.cs      # Configuraci√≥n
‚îú‚îÄ‚îÄ Services/               # Servicios de negocio
‚îÇ   ‚îú‚îÄ‚îÄ IEmailService.cs   # Interface email
‚îÇ   ‚îî‚îÄ‚îÄ EmailService.cs    # Implementaci√≥n email
‚îú‚îÄ‚îÄ Data/                  # Contexto de datos
‚îÇ   ‚îî‚îÄ‚îÄ MongoDbContext.cs  # Conexi√≥n MongoDB
‚îú‚îÄ‚îÄ Properties/            # Configuraci√≥n del proyecto
‚îú‚îÄ‚îÄ .env                   # Variables de entorno
‚îú‚îÄ‚îÄ Program.cs             # Configuraci√≥n principal
‚îî‚îÄ‚îÄ README.md             # Este archivo
```

## üéØ Funcionalidades Exclusivas QR

### üîç Tipos de QR Implementados

1. **check_in** - Check-in autom√°tico para turnos
2. **payment_confirmation** - Confirmaci√≥n de pagos
3. **service_access** - Acceso a servicios premium
4. **special_offer** - Ofertas especiales exclusivas

### üîÑ Flujo de Procesamiento QR

1. **Generaci√≥n** - `POST /api/qr/generate` con datos espec√≠ficos
2. **Validaci√≥n** - `GET /api/qr/validate/{token}` autom√°tica
3. **Procesamiento** - Acci√≥n espec√≠fica seg√∫n el tipo
4. **Marcado** - Token marcado como usado autom√°ticamente

## üìä Configuraci√≥n y Despliegue

### Variables de Entorno Requeridas
- **MongoDB**: ConnectionString y DatabaseName
- **JWT**: Key, Issuer, Audience, DurationInMinutes
- **Email**: Configuraci√≥n Gmail o servicio alternativo
- **QRCode**: BaseUrl para generaci√≥n de enlaces
- **CORS**: AllowedOrigins para frontend

### Configuraci√≥n de Producci√≥n
```env
# Producci√≥n
JWT__DurationInMinutes=60
QRCode__BaseUrl=https://tu-dominio.com/api/qr
CORS__AllowedOrigins=https://tu-frontend.com
```

## üé• Demo y Capturas

Para ver el funcionamiento completo, revisar la carpeta `/videos` en el repositorio principal.

## ü§ù Contribuci√≥n

Este proyecto es parte del TP Integrador 2025. Para contribuir:

1. Fork el repositorio
2. Crear feature branch (`git checkout -b feature/nueva-funcionalidad`)
3. Commit cambios (`git commit -am 'Agregar nueva funcionalidad'`)
4. Push branch (`git push origin feature/nueva-funcionalidad`)
5. Crear Pull Request

## üìÑ Licencia

Este proyecto est√° bajo la Licencia MIT - ver archivo [LICENSE](LICENSE) para detalles.

---

**Desarrollado para el TP Integrador 2025**  
*Arquitectura: API ASP.NET Core + MVC + SPA Next.js* 